/*!
 * TinyDrive
 *
 * Copyright (c) 2023 Ephox Corporation DBA Tiny Technologies, Inc.
 * Licensed under the Tiny commercial license. See https://www.tiny.cloud/legal/
 *
 * Version: 2.0.3-68
 */

!function(){"use strict";const e=e=>{let t=e;return{get:()=>t,set:e=>{t=e}}},t=Object.getPrototypeOf,r=(e,t,r)=>{var o;return!!r(e,t.prototype)||(null===(o=e.constructor)||void 0===o?void 0:o.name)===t.name},o=e=>t=>(e=>{const t=typeof e;return null===e?"null":"object"===t&&Array.isArray(e)?"array":"object"===t&&r(e,String,((e,t)=>t.isPrototypeOf(e)))?"string":t})(t)===e,n=e=>t=>typeof t===e,s=o("string"),a=o("object"),i=e=>((e,o)=>a(e)&&r(e,o,((e,r)=>t(e)===r)))(e,Object),l=o("array"),u=n("boolean"),d=(void 0,e=>undefined===e);const c=e=>!(e=>null==e)(e),p=n("function"),m=n("number");class h{constructor(e,t){this.tag=e,this.value=t}static some(e){return new h(!0,e)}static none(){return h.singletonNone}fold(e,t){return this.tag?t(this.value):e()}isSome(){return this.tag}isNone(){return!this.tag}map(e){return this.tag?h.some(e(this.value)):h.none()}bind(e){return this.tag?e(this.value):h.none()}exists(e){return this.tag&&e(this.value)}forall(e){return!this.tag||e(this.value)}filter(e){return!this.tag||e(this.value)?this:h.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(null!=e?e:"Called getOrDie on None")}static from(e){return c(e)?h.some(e):h.none()}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value)}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}}h.singletonNone=new h(!1);const f=e=>parseInt(e,10),g=(e,t)=>{const r=e-t;return 0===r?0:r>0?1:-1},y=(e,t,r)=>({major:e,minor:t,patch:r}),v=e=>{const t=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(e);return t?y(f(t[1]),f(t[2]),f(t[3])):y(0,0,0)},b=()=>{},w=(e,t)=>(...r)=>e(t.apply(null,r)),T=e=>()=>e,x=e=>e,O=(e,t)=>e===t;function U(e,...t){return(...r)=>{const o=t.concat(r);return e.apply(null,o)}}const k=e=>e(),j=T(!1),_=T(!0),P=Array.prototype.indexOf,D=Array.prototype.push,S=(e,t)=>((e,t)=>P.call(e,t))(e,t)>-1,E=(e,t)=>{for(let r=0,o=e.length;r<o;r++)if(t(e[r],r))return!0;return!1},M=(e,t)=>{const r=e.length,o=new Array(r);for(let n=0;n<r;n++){const r=e[n];o[n]=t(r,n)}return o},C=(e,t)=>{for(let r=0,o=e.length;r<o;r++)t(e[r],r)},F=(e,t)=>{const r=[];for(let o=0,n=e.length;o<n;o++){const n=e[o];t(n,o)&&r.push(n)}return r},B=(e,t,r)=>(C(e,((e,o)=>{r=t(r,e,o)})),r),N=(e,t)=>((e,t,r)=>{for(let o=0,n=e.length;o<n;o++){const n=e[o];if(t(n,o))return h.some(n);if(r(n,o))break}return h.none()})(e,t,j),R=e=>{const t=[];for(let r=0,o=e.length;r<o;++r){if(!l(e[r]))throw new Error("Arr.flatten item "+r+" was not an array, input: "+e);D.apply(t,e[r])}return t},z=(e,t)=>R(M(e,t)),A=e=>((e,t)=>0<e.length?h.some(e[0]):h.none())(e),I=e=>{const t=t=>t(e),r=T(e),o=()=>n,n={tag:!0,inner:e,fold:(t,r)=>r(e),isValue:_,isError:j,map:t=>L.value(t(e)),mapError:o,bind:t,exists:t,forall:t,getOr:r,or:o,getOrThunk:r,orThunk:o,getOrDie:r,each:t=>{t(e)},toOptional:()=>h.some(e)};return n},q=e=>{const t=()=>r,r={tag:!1,inner:e,fold:(t,r)=>t(e),isValue:j,isError:_,map:t,mapError:t=>L.error(t(e)),bind:t,exists:j,forall:_,getOr:x,or:x,getOrThunk:k,orThunk:k,getOrDie:(o=String(e),()=>{throw new Error(o)}),each:b,toOptional:h.none};var o;return r},L={value:I,error:q,fromOption:(e,t)=>e.fold((()=>q(t)),I)},$="undefined"!=typeof window?window:Function("return this;")(),J=Object.keys,H=Object.hasOwnProperty,K=(e,t)=>{const r=J(e);for(let o=0,n=r.length;o<n;o++){const n=r[o];t(e[n],n)}},V=(e,t)=>W(e,((e,r)=>({k:r,v:t(e,r)}))),W=(e,t)=>{const r={};return K(e,((e,o)=>{const n=t(e,o);r[n.k]=n.v})),r},Y=e=>(t,r)=>{e[r]=t},Z=(e,t)=>{const r=[];return K(e,((e,o)=>{r.push(t(e,o))})),r},X=e=>Z(e,x),G=(e,t)=>Q(e,t)?h.from(e[t]):h.none(),Q=(e,t)=>H.call(e,t),ee=e=>{if(null==e)throw new Error("Node cannot be null or undefined");return{dom:e}},te=(e,t)=>{const r=(t||document).createElement(e);return ee(r)},re=ee,oe=e=>1===(e=>e.dom.nodeType)(e),ne=(e,t)=>{e.dom.appendChild(t.dom)},se=p(Element.prototype.attachShadow)&&p(Node.prototype.getRootNode),ae=T(se),ie=(e,t)=>{const r=e.dom;K(t,((e,t)=>{((e,t,r)=>{if(!(s(r)||u(r)||m(r)))throw console.error("Invalid call to Attribute.set. Key ",t,":: Value ",r,":: Element ",e),new Error("Attribute value was not simple");e.setAttribute(t,r+"")})(r,t,e)}))},le=e=>{const t=re((e=>{if(ae()&&c(e.target)){const t=re(e.target);if(oe(t)&&c(t.dom.shadowRoot)&&e.composed&&e.composedPath){const t=e.composedPath();if(t)return A(t)}}return h.from(e.target)})(e).getOr(e.target)),r=()=>e.stopPropagation(),o=()=>e.preventDefault(),n=w(o,r);return((e,t,r,o,n,s,a)=>({target:e,x:t,y:r,stop:o,prevent:n,kill:s,raw:a}))(t,e.clientX,e.clientY,r,o,n,e)},ue=(e,t,r,o)=>{e.dom.removeEventListener(t,r,o)},de=_,ce=(e,t,r)=>((e,t,r,o)=>((e,t,r,o,n)=>{const s=((e,t)=>r=>{e(r)&&t(le(r))})(r,o);return e.dom.addEventListener(t,s,n),{unbind:U(ue,e,t,s,n)}})(e,t,r,o,!1))(e,t,de,r),pe=(e,t)=>((e,r)=>N(e.dom.childNodes,(e=>((e,t)=>{const r=e.dom;if(1!==r.nodeType)return!1;{const e=r;if(void 0!==e.matches)return e.matches(t);if(void 0!==e.msMatchesSelector)return e.msMatchesSelector(t);if(void 0!==e.webkitMatchesSelector)return e.webkitMatchesSelector(t);if(void 0!==e.mozMatchesSelector)return e.mozMatchesSelector(t);throw new Error("Browser lacks native selectors")}})(re(e),t))).map(re))(e),me=(e,t)=>new Promise((r=>{const o=te("script");ie(o,{src:e,...t}),ce(o,"load",(()=>{r(L.value(o))})),ce(o,"error",(()=>{r(L.error(`Failed to load script: ${e}`))})),ne((e=>{const t=e.dom.body;if(null==t)throw new Error("Body is not available yet");return re(t)})(re(document)),o)})),he=e=>new Promise((t=>{const r=(e=>{const t=e.dom.head;if(null==t)throw new Error("Head is not available yet");return re(t)})(re(document)),o=((e,t)=>pe(e,`link[href="${t}"]`))(r,e),n=te("link");ie(n,{rel:"stylesheet",href:e}),ce(n,"load",(()=>{t(L.value(n))})),ce(n,"error",(()=>{t(L.error(`Failed to load css: ${e}`)),(e=>{const t=e.dom;null!==t.parentNode&&t.parentNode.removeChild(t)})(n)})),o.fold((()=>ne(r,n)),(e=>t(L.value(e))))})),fe=(e,t,r)=>G(e,t).fold((()=>((e,t,r)=>me(r,{}).then((r=>L.fromOption(G(e,t),`Could not find "${t}" in the given namespace`))))(e,t,r)),(e=>Promise.resolve(L.value(e)))),ge=e=>e<10?"0"+e.toString():e.toString(),ye=e=>{let t=h.none(),r=[];const o=e=>{n()?s(e):r.push(e)},n=()=>t.isSome(),s=e=>{t.each((t=>{setTimeout((()=>{e(t)}),0)}))};return e((e=>{n()||(t=h.some(e),C(r,s),r=[])})),{get:o,map:e=>ye((t=>{o((r=>{t(e(r))}))})),isReady:n}},ve={nu:ye,pure:e=>ye((t=>{t(e)}))},be=e=>{setTimeout((()=>{throw e}),0)},we=e=>{const t=t=>{e().then(t,be)};return{map:t=>we((()=>e().then(t))),bind:t=>we((()=>e().then((e=>t(e).toPromise())))),anonBind:t=>we((()=>e().then((()=>t.toPromise())))),toLazy:()=>ve.nu(t),toCached:()=>{let t=null;return we((()=>(null===t&&(t=e()),t)))},toPromise:e,get:t}},Te=e=>we((()=>new Promise(e))),xe=e=>we((()=>Promise.resolve(e))),Oe=e=>({...e,toCached:()=>Oe(e.toCached()),bindFuture:t=>Oe(e.bind((e=>e.fold((e=>xe(L.error(e))),(e=>t(e)))))),bindResult:t=>Oe(e.map((e=>e.bind(t)))),mapResult:t=>Oe(e.map((e=>e.map(t)))),mapError:t=>Oe(e.map((e=>e.mapError(t)))),foldResult:(t,r)=>e.map((e=>e.fold(t,r))),withTimeout:(t,r)=>Oe(Te((o=>{let n=!1;const s=setTimeout((()=>{n=!0,o(L.error(r()))}),t);e.get((e=>{n||(clearTimeout(s),o(e))}))})))}),Ue=e=>Oe(Te(e)),ke=e=>Oe(xe(L.value(e))),je=e=>Oe(xe(L.error(e))),_e=(e,t)=>((e,t,r)=>""===t||e.length>=t.length&&e.substr(0,0+t.length)===t)(e,t);var Pe;!function(e){e.JSON="json",e.Blob="blob",e.Text="text",e.FormData="formdata",e.MultipartFormData="multipart/form-data"}(Pe||(Pe={}));const De=e=>({type:Pe.JSON,data:e}),Se=e=>Te((t=>{const r=new FileReader;r.onload=e=>{const r=e.target?e.target.result:"";t(r)},r.readAsText(e)})),Ee=e=>{try{const t=JSON.parse(e);return L.value(t)}catch(e){return L.error("Response was not JSON.")}},Me=e=>xe(e.response),Ce=e=>Ue((t=>{const r=new XMLHttpRequest;var o;r.open(e.method,(o=e.url,h.from(e.query).map((e=>{const t=Z(e,((e,t)=>encodeURIComponent(t)+"="+encodeURIComponent(e))),r=((e,t,r=0,o)=>{const n=e.indexOf(t,r);return-1!==n&&(!!d(o)||n+t.length<=o)})(o,"?")?"&":"?";return t.length>0?o+r+t.join("&"):o})).getOr(o)),!0);const n=(e=>{const t=(r=e.body,h.from(r).bind((e=>{switch(e.type){case Pe.JSON:return h.some("application/json");case Pe.FormData:return h.some("application/x-www-form-urlencoded; charset=UTF-8");case Pe.MultipartFormData:return h.none();case Pe.Text:default:return h.some("text/plain")}})));var r;const o=!0===e.credentials?h.some(!0):h.none(),n=(e=>{switch(e){case Pe.Blob:return"application/octet-stream";case Pe.JSON:return"application/json, text/javascript";case Pe.Text:return"text/plain";default:return""}})(e.responseType)+", */*; q=0.01",s=void 0!==e.headers?e.headers:{};return{contentType:t,responseType:(e=>{switch(e){case Pe.JSON:return h.none();case Pe.Blob:return h.some("blob");case Pe.Text:return h.some("text");default:return h.none()}})(e.responseType),credentials:o,accept:n,headers:s,progress:p(e.progress)?h.some(e.progress):h.none()}})(e);((e,t)=>{t.contentType.each((t=>e.setRequestHeader("Content-Type",t))),e.setRequestHeader("Accept",t.accept),t.credentials.each((t=>e.withCredentials=t)),t.responseType.each((t=>e.responseType=t)),t.progress.each((t=>e.upload.addEventListener("progress",(e=>t(e.loaded,e.total))))),K(t.headers,((t,r)=>e.setRequestHeader(r,t)))})(r,n);const s=()=>{((e,t,r)=>((e,t)=>{switch(e){case Pe.JSON:return Ee(t.response).fold((()=>Me(t)),xe);case Pe.Blob:return(e=>h.from(e.response).map(Se).getOr(xe("no response content")))(t);case Pe.Text:default:return Me(t)}})(t,r).map((t=>({message:0===r.status?"Unknown HTTP error (possible cross-domain request)":`Could not load url ${e}: ${r.statusText}`,status:r.status,responseText:t}))))(e.url,e.responseType,r).get((e=>t(L.error(e))))};var a;r.onerror=s,r.onload=()=>{0!==r.status||_e(e.url,"file:")?r.status<100||r.status>=400?s():((e,t)=>{const r=e=>je({message:e,status:t.status,responseText:t.responseText});switch(e){case Pe.JSON:return Ee(t.response).fold(r,ke);case Pe.Blob:case Pe.Text:return ke(t.response);default:return r("unknown data type")}})(e.responseType,r).get(t):s()},(a=e.body,h.from(a).map((e=>e.type===Pe.JSON?JSON.stringify(e.data):e.type===Pe.FormData||e.type===Pe.MultipartFormData?(e=>{const t=new FormData;return K(e,((e,r)=>{t.append(r,e)})),t})(e.data):e.data))).fold((()=>r.send()),(e=>{r.send(e)}))})),Fe=e=>Ce({...e,method:"post"}),Be=(e,t,r)=>L.error({message:t,status:e,responseText:r}),Ne=(e,t)=>Fe({url:e,responseType:Pe.JSON,body:De({})}).bindResult((r=>s(r.token)?((e,t)=>(t.set(h.some(e)),L.value(e)))(r.token,t):((e,t)=>(t.set(h.none()),Be(500,`Jwt token provider: "${e}" did not return a "token" string property in it's JSON response body.`,"")))(e,t))),Re=(e,t)=>Ue((r=>{e((e=>{t.set(h.some(e.token)),r(L.value(e.token))}),(e=>{t.set(h.none()),r(Be(0,e,""))}))})),ze=(e,t)=>s(e)?((e,t)=>r=>r?Ne(e,t):t.get().fold((()=>Ne(e,t)),(e=>ke(e))))(e,t):p(e)?((e,t)=>r=>r?Re(e,t):t.get().fold((()=>Re(e,t)),(e=>ke(e))))(e,t):("Required jwt token provider not defined.",e=>{return t=Be(0,"Required jwt token provider not defined.",""),Oe(xe(t));var t}),Ae="oxide",Ie=[Ae,"oxide-dark"],qe=e=>S(Ie,e),Le=e=>t=>t.options.get(e),$e=e=>t=>h.from(e(t)),Je=e=>{var t;return h.from(null!==(t=e.options.get("tinydrive_api_key"))&&void 0!==t?t:e.options.get("api_key"))},He=Le("tinydrive_script_url"),Ke=$e(Le("tinydrive_demo_files_url")),Ve=$e(Le("tinydrive_demo_files")),We=$e(Le("tinydrive_service_url")),Ye=$e(Le("tinydrive_max_image_dimension")),Ze=$e(Le("tinydrive_dropbox_app_key")),Xe=$e(Le("tinydrive_google_drive_key")),Ge=$e(Le("tinydrive_google_drive_client_id")),Qe=$e(Le("tinydrive_css_url")),et=$e(Le("skin")),tt=$e(Le("tinydrive_skin")),rt=(e,t)=>Qe(e).getOrThunk((()=>{const r=tt(e).orThunk((()=>et(e))).filter(qe).getOr(Ae);return((e,t)=>"oxide"===t?`${e}/assetmanager.min.css`:`${e}/skins/${t}.min.css`)(t,r)})),ot=(e,t)=>{const r=e.options.get("tinydrive_token_provider");return ze(r,t)},nt=Le("tinydrive_upload_path"),st=e=>(...t)=>{if(0===t.length)throw new Error("Can't merge zero objects");const r={};for(let o=0;o<t.length;o++){const n=t[o];for(const t in n)Q(n,t)&&(r[t]=e(r[t],n[t]))}return r},at=st(((e,t)=>i(e)&&i(t)?at(e,t):t)),it=st(((e,t)=>t)),lt=e=>t=>t.fold((e=>Promise.resolve(L.error(e))),e),ut=e=>t=>Promise.resolve(t.bind(e)),dt=e=>t=>t.mapError(e),ct=e=>e.then((e=>new Promise(((t,r)=>{e.fold(r,t)})))),pt=e=>e.replace(/\\/g,"/"),mt=(e,t,...r)=>{const o=pt(e).replace(/\/$/,"")+"/"+pt(t).replace(/^\//,"");return B(r,((e,t)=>mt(e,t)),o)},ht=e=>{const t=[],r=e=>{t.push(e)};for(let t=0;t<e.length;t++)e[t].each(r);return t},ft=(e,t,r)=>e.sort(((e,o)=>{if("name"===t)return"desc"===r?o.name.localeCompare(e.name):e.name.localeCompare(o.name);if("size"===t)return"desc"===r?o.size-e.size:e.size-o.size;{const t=e.modificationDate.getTime(),n=o.modificationDate.getTime();return"desc"===r?n-t:t-n}})),gt=(e,t,r)=>{const o=((e,t)=>{const r=[],o=[];for(let t=0,s=e.length;t<s;t++){const s=e[t];(n=s,"directory"===n.type?r:o).push(s)}var n;return{pass:r,fail:o}})(e);return ft(o.pass,t,r).concat(ft(o.fail,t,r))},yt=e=>({type:"",message:e}),vt=e=>({type:"",message:e.message});let bt=0;const wt=()=>(e=>{const t=(new Date).getTime(),r=Math.floor(1e9*Math.random());return bt++,"file_"+r+bt+String(t)})(),Tt=(e,t)=>{const r=((e,t,r)=>N(e,(e=>t.fold((()=>e.parentUuid.isNone()&&e.name===r),(t=>e.parentUuid.exists((o=>o===t&&e.name===r)))))))(e.files,e.parentUuid,t);return r.fold((()=>{const r={uuid:wt(),type:"directory",parentUuid:e.parentUuid,name:t,size:0,modificationDate:new Date,url:h.none(),thumbUrl:h.none(),starred:!1,path:h.none()};return{files:e.files.concat([r]),parentUuid:h.some(r.uuid)}}),(t=>({files:e.files,parentUuid:h.some(t.uuid)})))},xt=(e,t)=>B((e=>F(e.split("/"),(e=>e.length>0)))(t),Tt,{files:e,parentUuid:h.none()}),Ot=e=>h.from(e.split(".")[1]).map((e=>JSON.parse(window.atob(e)))),Ut=R(X({"image/webp":["webp"],"image/gif":["gif"],"image/jpeg":["jpeg","jpg","jpe","jfi","jif","jfif","pjpeg","pjp"],"image/apng":["apng"],"image/avif":["avif"],"image/png":["png"],"image/tiff":["tif","tiff"],"image/bmp":["bmp"]})),kt=R(X({"application/msword":["doc"],"application/vnd.ms-excel":["xls"],"application/vnd.ms-powerpoint":["ppt","pps"],"application/vnd.openxmlformats-officedocument.wordprocessingml.document":["docx"],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":["xlsx"],"application/vnd.openxmlformats-officedocument.presentationml.presentation":["pptx"],"application/pdf":["pdf"],"application/rtf":["rtf"],"text/plain":["txt"],"application/x-iwork-keynote-sffkey":["key"],"application/x-iwork-pages-sffpages":["pages"],"application/x-iwork-numbers-sffnumbers":["numbers"]})),jt=R(X({"audio/wav":["wav","wave"],"audio/mpeg":["mp3"],"audio/ogg":["ogg","oga","ogx","ogm","spx","opus"]})),_t=R(X({"video/mp4":["mp4","m4v"],"video/ogg":["ogv"],"video/webm":["webm"],"video/quicktime":["mov"]})),Pt=R(X({"application/zip":["zip"]})),Dt=e=>{const t=(e=>{const t=e.lastIndexOf(".");return-1!==t?e.substr(t):""})(e).substring(1).toLowerCase();return S(Ut,t)?h.some("image"):S(kt,t)?h.some("document"):S(jt,t)?h.some("audio"):S(_t,t)?h.some("video"):S(Pt,t)?h.some("archive"):h.none()},St=e=>{switch(e){case"directory":return"directory";case"document":return"document";case"audio":return"audio";case"video":return"video";case"image":return"image";case"archive":return"archive"}},Et=e=>{switch(e){case"directory":return h.some("directory");case"document":return h.some("document");case"audio":return h.some("audio");case"video":return h.some("video");case"image":return h.some("image");case"archive":return h.some("archive");default:return h.none()}},Mt=e=>{const t=ht(M(e,Et));return t.length>0?["directory"].concat(t):[]};var Ct;!function(e){e[e.Error=0]="Error",e[e.Value=1]="Value"}(Ct||(Ct={}));const Ft=(e,t,r)=>e.stype===Ct.Error?t(e.serror):r(e.svalue),Bt=e=>({stype:Ct.Value,svalue:e}),Nt=e=>({stype:Ct.Error,serror:e}),Rt=Ft,zt=e=>a(e)&&J(e).length>100?" removed due to size":JSON.stringify(e,null,2),At=(e,t)=>Nt([{path:e,getErrorInfo:t}]),It=e=>{const t=(e=>{const t=[],r=[];return C(e,(e=>{Ft(e,(e=>r.push(e)),(e=>t.push(e)))})),{values:t,errors:r}})(e);return t.errors.length>0?(r=t.errors,w(Nt,R)(r)):Bt(t.values);var r},qt=(e,t,r)=>{switch(e.tag){case"field":return t(e.key,e.newKey,e.presence,e.prop);case"custom":return r(e.newKey,e.instantiator)}},Lt=e=>({extract:(t,r)=>{return o=e(r),n=e=>((e,t)=>At(e,T(t)))(t,e),o.stype===Ct.Error?n(o.serror):o;var o,n},toString:T("val")}),$t=Lt(Bt),Jt=(e,t,r,o)=>o(G(e,t).getOrThunk((()=>r(e)))),Ht=(e,t,r,o,n)=>{const s=e=>n.extract(t.concat([o]),e),a=e=>e.fold((()=>Bt(h.none())),(e=>{const r=n.extract(t.concat([o]),e);return s=r,a=h.some,s.stype===Ct.Value?{stype:Ct.Value,svalue:a(s.svalue)}:s;var s,a}));switch(e.tag){case"required":return((e,t,r,o)=>G(t,r).fold((()=>((e,t,r)=>At(e,(()=>'Could not find valid *required* value for "'+t+'" in '+zt(r))))(e,r,t)),o))(t,r,o,s);case"defaultedThunk":return Jt(r,o,e.process,s);case"option":return((e,t,r)=>r(G(e,t)))(r,o,a);case"defaultedOptionThunk":return((e,t,r,o)=>o(G(e,t).map((t=>!0===t?r(e):t))))(r,o,e.process,a);case"mergeWithThunk":return Jt(r,o,T({}),(t=>{const o=at(e.process(r),t);return s(o)}))}},Kt=e=>({extract:(t,r)=>((e,t,r)=>{const o={},n=[];for(const s of r)qt(s,((r,s,a,i)=>{const l=Ht(a,e,t,r,i);Rt(l,(e=>{n.push(...e)}),(e=>{o[s]=e}))}),((e,r)=>{o[e]=r(t)}));return n.length>0?Nt(n):Bt(o)})(t,r,e),toString:()=>{const t=M(e,(e=>qt(e,((e,t,r,o)=>e+" -> "+o.toString()),((e,t)=>"state("+e+")"))));return"obj{\n"+t.join("\n")+"}"}}),Vt=e=>({extract:(t,r)=>{const o=M(r,((r,o)=>e.extract(t.concat(["["+o+"]"]),r)));return It(o)},toString:()=>"array("+e.toString()+")"}),Wt=(e,t,r)=>{return o=((e,t,r)=>((e,t)=>e.stype===Ct.Error?{stype:Ct.Error,serror:t(e.serror)}:e)(t.extract([e],r),(e=>({input:r,errors:e}))))(e,t,r),Ft(o,L.error,L.value);var o},Yt=e=>"Errors: \n"+(e=>{const t=e.length>10?e.slice(0,10).concat([{path:[],getErrorInfo:T("... (only showing first ten failures)")}]):e;return M(t,(e=>"Failed path: ("+e.path.join(" > ")+")\n"+e.getErrorInfo()))})(e.errors).join("\n")+"\n\nInput object: "+zt(e.input),Zt=T($t),Xt=(e,t)=>Lt((r=>{const o=typeof r;return e(r)?Bt(r):Nt(`Expected type: ${t} but got: ${o}`)})),Gt=Xt(m,"number"),Qt=Xt(s,"string"),er=Xt(u,"boolean"),tr=Xt(p,"function"),rr=(e,t,r,o)=>({tag:"field",key:e,newKey:t,presence:r,prop:o}),or=(e,t)=>rr(e,e,{tag:"required",process:{}},t),nr=e=>or(e,Gt),sr=e=>or(e,Qt),ar=e=>or(e,er),ir=(e,t)=>rr(e,e,{tag:"required",process:{}},Vt(t)),lr=e=>((e,t)=>rr(e,e,{tag:"option",process:{}},t))(e,Qt),ur=(e,t,r)=>rr(e,e,(e=>({tag:"defaultedThunk",process:T(e)}))(t),r),dr=Kt([sr("name"),sr("sub"),lr("root"),rr("https://claims.tiny.cloud/drive/root","root",{tag:"option",process:{}},Qt)]),cr=(e,t)=>{e.set(it(e.get(),{files:t}))},pr=(e,t)=>{e.set(it(e.get(),{meta:it(e.get().meta,t)}))},mr=(e,t)=>{const r={},o=B(t,((t,o)=>{const n=m(o.size)?Dt(o.name).getOr("document"):"directory",a=o.size?o.size:0,i=s(o.date)?(d=o.date,(e=>h.from(/^([0-9]{4})\-([0-9]{2})\-([0-9]{2}) ([0-9]{2})\:([0-9]{2})\:([0-9]{2})$/.exec(e)))(d).map((e=>{const t=Date.parse(`${e[1]}-${e[2]}-${e[3]}T${e[4]}:${e[5]}:${e[6]}Z`);return new Date(t)}))).getOr(new Date):new Date,l=o.uuid?o.uuid:wt(),u={uuid:l,type:n,parentUuid:h.from(o.parentUuid),name:o.name,size:a,modificationDate:i,url:h.from(o.url),thumbUrl:h.from(o.thumbUrl),starred:!0===o.starred,path:h.none()};var d;return r[l]=((e,t)=>{const r=e.meta?e.meta:{},o=h.from(r.createdBy).orThunk((()=>Ot(t).map((e=>e.name))));return{description:r.description?r.description:"",createdBy:o}})(o,e),((e,t,r)=>{const o=xt(e,t);return o.files.concat([it(r,{parentUuid:o.parentUuid})])})(t,o.path,u)}),[]),n=(e=>Ot(e).bind((e=>Wt("claims",dr,e).toOptional())))(e).getOr({name:"",sub:"",root:h.none()});return n.root.fold((()=>({files:o,meta:r,claims:n,rootUuid:h.none()})),(e=>{const t=xt(o,e),s=t.parentUuid;return{files:t.files,meta:r,claims:n,rootUuid:s}}))},hr=(e,t)=>h.from(e).or(t.get().rootUuid),fr=(e,t)=>e.parentUuid.bind((e=>gr(e,t))),gr=(e,t)=>N(t,(t=>t.uuid===e)),yr=(e,t)=>it(e,{path:t}),vr=(e,t)=>yr(e,h.some(((e,t)=>{const r=[];for(let o=fr(e,t);o.isSome();o=o.bind((e=>fr(e,t))))o.each((e=>r.push(e)));return"/"+M(r.reverse(),(e=>e.name)).concat([e.name]).join("/")})(e,t))),br=(e,t)=>e.query.fold(_,(e=>-1!==t.name.toLowerCase().indexOf(e.toLowerCase()))),wr=(e,t)=>0===e.fileTypes.length||E(e.fileTypes,(e=>e===t.type)),Tr=(e,t,r,o,n)=>new Promise((s=>{const a=n.or(e.get().rootUuid);Dt(r).fold((()=>s(L.error({type:"",message:`Invalid file extension for "${r}"`}))),(n=>{const i=wt(),l={uuid:i,type:n,parentUuid:a,name:r,size:t.size,modificationDate:new Date,url:h.some(URL.createObjectURL(t)),thumbUrl:o.map((e=>URL.createObjectURL(e))),starred:!1,path:h.none()};pr(e,{[i]:{description:"",createdBy:h.some(e.get().claims.name)}}),cr(e,e.get().files.concat([l])),s(L.value(l))}))})),xr=e=>t=>new Promise((r=>{((e,o,n,s)=>{const a=(o,n)=>{setTimeout((()=>{n<o?(e(n,o),a(o,n+1)):(e(n,o),r(L.value(t)))}),10)};a(10,0)})(((r,o)=>{const n=Math.round(t.size*(r/o));e({name:t.name,uuid:t.uuid,loaded:n,total:t.size})}))})),Or=(t,r)=>{const o=((e,t)=>r=>e().then(ut((e=>(t.log&&console.log("memfs:",r,e.get().claims),L.value(e))))))(((t,r)=>{const o=e({files:[],meta:{},claims:{name:"",sub:"",root:h.none()},rootUuid:h.none()});return()=>{return t.jwtTokenFactory(!1).toPromise().then((e=t.requestDelay,t=>new Promise((r=>{setTimeout((()=>{r(t)}),e)})))).then(dt(vt)).then((e=>r.then(lt((t=>(o.get().files.length<=0&&e.each((e=>o.set(mr(e,t)))),Promise.resolve(L.value(o))))))));var e}})(t,r),t),n=(e,t,r)=>{const o=h.from(e.get().meta[t]).fold((()=>({[t]:{description:"",createdBy:h.none(),...r}})),(e=>({[t]:it(e,r)})));pr(e,it(e.get().meta,o))},a=(e,t)=>e.claims.root.map((e=>t.path.exists((t=>{return e===t||(r=e,0===mt(t,"/").indexOf(mt(r,"/")));var r})))).getOr(!0),i=(e,t)=>M(e,(e=>t.fold(T(e),(t=>yr(e,e.path.map((e=>{var r,o;return"/"+(_e(r=e,o=t+"/")?((e,t)=>e.substring(t))(r,o.length):r)})))))));return{rename:(e,t)=>o("rename").then(lt((r=>new Promise((o=>{var n,s;cr(r,M(r.get().files,(r=>r.uuid===e?it(r,{name:t}):r))),A((n=r.get().files,s=[e],F(n,(e=>S(s,e.uuid))))).fold((()=>o(L.error({type:"error",message:"File not found"}))),(e=>o(L.value(e.uuid))))}))))),mkdir:(e,t)=>o("mkdir").then(lt((r=>new Promise((o=>{const n=wt(),a={uuid:n,type:"directory",parentUuid:s(t)?hr(t,r):h.none(),name:e,size:0,modificationDate:new Date,url:h.none(),thumbUrl:h.none(),starred:!1,path:h.none()};((e,t,r)=>E(F(e,(e=>t.fold((()=>e.parentUuid.isNone()),(t=>e.parentUuid.exists((e=>e===t)))))),(e=>"directory"===e.type&&e.name===r)))(r.get().files,h.from(t),e)?o(L.error({type:"x",message:"Directory already exists"})):(cr(r,r.get().files.concat([a])),o(L.value(n)))}))))),upload:e=>o("upload").then(lt((t=>((e,t)=>Tr(e,t.blob,t.name,t.thumbBlob,t.parent).then(lt(xr(t.progress))))(t,e)))),list:e=>o("list").then(lt((r=>new Promise((o=>{const n=F(r.get().files,(t=>((e,t,r)=>e.parentUuid.fold((()=>r.fold((()=>t.parentUuid.isNone()),(e=>t.parentUuid.exists((t=>t===e))))),(e=>t.parentUuid.exists((t=>t===e)))))(e,t,r.get().rootUuid)&&br(e,t)&&wr(e,t))),s=gt(n,e.sortBy,e.sortOrder),a=s.slice(e.offset,e.offset+t.limit),i=e.offset+a.length;o(L.value({last:i>=s.length,offset:i,files:a}))}))))),listStarred:e=>o("listStarred").then(lt((r=>new Promise((o=>{const n=r.get().claims.root,s=z(r.get().files,(t=>{const o=vr(t,r.get().files);return a(r.get(),o)&&br(e,o)&&wr(e,t)&&!0===o.starred?[o]:[]})),l=gt(s,e.sortBy,e.sortOrder),u=l.slice(e.offset,e.offset+t.limit),d=e.offset+u.length;o(L.value({last:d>=l.length,offset:d,files:i(u,n)}))}))))),search:e=>o("search").then(lt((r=>new Promise((o=>{const n=r.get().claims.root,s=z(r.get().files,(t=>{const o=vr(t,r.get().files);return a(r.get(),o)&&br(e,o)&&wr(e,t)&&"directory"!==t.type?[o]:[]})),l=gt(s,e.sortBy,e.sortOrder),u=l.slice(e.offset,e.offset+t.limit),d=e.offset+u.length;o(L.value({last:d>=l.length,offset:d,files:i(u,n)}))}))))),remove:e=>o("remove").then(lt((t=>new Promise((r=>{cr(t,z(t.get().files,(t=>S(e,t.uuid)?[]:[t]))),r(L.value(e))}))))),copy:(e,t)=>o("copy").then(lt((r=>new Promise((o=>{const s=wt();cr(r,z(r.get().files,(r=>r.uuid===e?[r,it(r,{uuid:s,parentUuid:h.from(t)})]:[r]))),r.get().meta[e]&&n(r,s,r.get().meta[e]),o(L.value(s))}))))),move:(e,t)=>o("move").then(lt((r=>new Promise((o=>{cr(r,M(r.get().files,(r=>S(e,r.uuid)?it(r,{parentUuid:h.from(t)}):r))),o(L.value(e))}))))),star:e=>o("star").then(lt((t=>new Promise((r=>{cr(t,M(t.get().files,(t=>S(e,t.uuid)?it(t,{starred:!0}):t))),r(L.value(e))}))))),unstar:e=>o("unstar").then(lt((t=>new Promise((r=>{cr(t,M(t.get().files,(t=>S(e,t.uuid)?it(t,{starred:!1}):t))),r(L.value(e))}))))),setMeta:(e,t)=>o("setMeta").then(lt((r=>new Promise((o=>{gr(e,r.get().files).fold((()=>o(L.error({type:"error",message:"No file!!"}))),(s=>{n(r,e,{description:t.description}),o(L.value(s.uuid))}))}))))),getMeta:e=>o("getMeta").then(lt((t=>new Promise((r=>{gr(e,t.get().files).fold((()=>r(L.error({type:"error",message:"No file!!"}))),(()=>{const o=t.get().meta[e];r(L.value(o||{description:"",createdBy:h.none()}))}))}))))),uploadToPath:e=>o("uploadToPath").then(lt((t=>((e,t)=>{const r=xt(e.get().files,((e,t)=>e.get().claims.root.map((e=>mt(e,t.path))).getOr(t.path))(e,t));return cr(e,r.files),Tr(e,t.blob,t.name,t.thumbBlob,r.parentUuid).then(lt(xr(t.progress)))})(t,e))))}},Ur=(e,t)=>t&&!/^https?:/.test(t)?mt(e,t):t,kr=(e,t)=>{const r={Authorization:"Bearer "+t};return e?{...e,...r}:r};var jr;!function(e){e.Thumbnail="thumbnail",e.File="file"}(jr||(jr={}));const _r=De,Pr=(e,t,r)=>Wt(e,t,r.data),Dr=Kt([sr("id"),sr("name"),nr("size"),sr("type"),sr("mdate"),lr("url"),ir("thumbs",Qt),ar("starred"),lr("path")]),Sr=e=>{return t=A(e.thumbs),r=e.url,o=(e,t)=>t+"-"+e,t.isSome()&&r.isSome()?h.some(o(t.getOrDie(),r.getOrDie())):h.none();var t,r,o},Er=e=>{return{uuid:e.id,parentUuid:h.none(),name:e.name,size:e.size,type:(r=e.type,Et(r).getOr("document")),modificationDate:(t=e.mdate,h.from(/^([0-9]{4})\-([0-9]{2})\-([0-9]{2})T([0-9]{2})\:([0-9]{2})\:([0-9]{2})Z$/.exec(t)).map((e=>{const t=M(e.slice(1),(e=>parseInt(e,10)));return new Date(Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5]))}))).getOr(new Date),url:e.url,thumbUrl:Sr(e),starred:e.starred,path:e.path};var t,r},Mr=(e,t,r,o)=>({last:t,offset:r,files:M(e,Er)}),Cr=Kt([or("file",Dr)]),Fr=(e,t)=>{const r=((e,t)=>{const r={},o={};return((e,t,r,o)=>{K(e,((e,n)=>{(t(e,n)?r:o)(e,n)}))})(e,t,Y(r),Y(o)),{t:r,f:o}})(V(e,((e,r)=>t[r](e))),(e=>e.isSome())).t,o=V(r,(e=>e.getOrNull()));return De(o)},Br=Kt([ir("id",Qt)]);var Nr;!function(e){e.Thumbnail="thumbnail",e.File="file"}(Nr||(Nr={}));const Rr=e=>Fr(e,{fileType:h.some,parent:x,path:x,name:h.some,size:h.some}),zr=Kt([sr("uploadUrl"),sr("blobUrl"),ir("formItems",Kt([sr("name"),sr("value")])),sr("id")]),Ar=e=>Pr("create",zr,e),Ir=Kt([(qr="error",Lr=[lr("type"),lr("data"),sr("message")],rr(qr,qr,{tag:"required",process:{}},Kt(Lr)))]);var qr,Lr;const $r=Kt([sr("message")]),Jr=e=>Fr(e,{offset:h.some,parent:x,sortBy:x,sortOrder:x,query:x,fileTypes:h.some}),Hr=Kt([ar("last"),nr("offset"),ir("files",Dr)]),Kr=e=>Pr("fileListResult",Hr,e),Vr=(e,t)=>Mr(t.files,t.last,t.offset),Wr=Kt([sr("id"),sr("description"),lr("createdBy")]),Yr=Kt([or("file",Dr)]),Zr=Kt([ir("ids",Qt)]),Xr=Kt([ir("ids",Qt)]),Gr=De,Qr=Kt([or("file",Dr)]),eo=Kt([sr("id")]),to=De,ro=Kt([ir("ids",Qt)]),oo=Kt([ar("last"),nr("offset"),ir("files",Dr)]),no=De,so=Kt([ir("ids",Qt)]),ao=e=>{return(t=De(e.responseText),Pr("error",Ir,t).fold((()=>(e=>Pr("error",$r,e).map((e=>({error:{type:h.none(),data:h.none(),message:e.message}}))))(t)),(e=>L.value(e)))).fold((t=>({type:"",message:"Error: "+e.message+" ("+e.status+")"})),(e=>({type:"",message:e.error.message})));var t},io=(e,t)=>mt(e.restApiEndpoint,"/1",t)+"?apiKey="+encodeURIComponent(e.apiKey),lo=(e,t,r)=>{var o,n;return(o={url:io(e,t),body:r,responseType:Pe.JSON},n=e.jwtTokenFactory,((e,t)=>(e=>e(!1))(t).bindFuture((r=>e(r).bind((r=>r.fold(((e,t)=>r=>401===r.status?(e=>e(!0))(e).bindFuture(t):je(r))(t,e),ke))))))((e=>Fe({...o,headers:kr(o.headers,e)})),n)).toPromise().then((e=>e.fold((e=>L.error(ao(e))),(e=>L.value(De(e))))))},uo=e=>M(e,St),co=(e,t,r)=>lo(e,"client/files/commit",_r({id:t,type:r})).then(ut((e=>{return(t=e,Pr("commit",Cr,t)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>L.value(e)));var t}))),po=(e,t,r,o,n)=>lo(e,"client/files/create",Rr({fileType:t,parent:r,path:h.none(),name:o,size:n})).then(ut((e=>Ar(e).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>L.value(e)))))),mo=(e,t,r,o,n)=>{const s=(a=t.formItems,i=B(a,((e,t)=>(e[t.name]=t.value,e)),{}),{type:Pe.MultipartFormData,data:i});var a,i;return s.data.file=o,Fe({url:t.uploadUrl,body:s,responseType:Pe.Text,progress:(e,o)=>n({loaded:e,total:o,name:r,uuid:t.id})}).toPromise().then((e=>e.fold((e=>L.error(ao(e))),(e=>L.value(t.id)))))},ho=(e,t,r)=>o=>t.fold((()=>Promise.resolve(L.value(o))),(t=>((e,t,r,o)=>po(e,Nr.Thumbnail,h.from(o),r,t.size).then(lt((e=>mo(0,e,r,t,b)))).then(lt((t=>co(e,t,jr.Thumbnail)))).then(ut((e=>L.value(e.file.id)))))(e,t,r,o.uuid).then((e=>L.value(o))))),fo=e=>({rename:(t,r)=>((e,t,r)=>lo(e,"client/files/rename",Gr({id:t,name:r})).then(ut((e=>{return(r=e,Pr("rename",Qr,r)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(()=>L.value(t)));var r}))))(e,t,r),mkdir:(t,r)=>((e,t,r)=>{return lo(e,"client/files/mkdir",(o={parent:t,name:r},Fr(o,{parent:x,name:h.some}))).then(ut((e=>{return(t=e,Pr("mkdir",Yr,t)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>L.value(e.file.id)));var t})));var o})(e,h.from(r),t),upload:t=>((e,t,r,o,n)=>po(e,Nr.File,n,r,t.size).then(lt((n=>mo(0,n,r,t,o).then(lt((t=>co(e,t,jr.File)))).then(ut((e=>L.value(Er(e.file)))))))))(e,t.blob,t.name,t.progress,t.parent).then(lt(ho(e,t.thumbBlob,t.name))),list:t=>((e,t,r)=>lo(e,"client/files/list",Jr({offset:t.offset,parent:t.parentUuid,sortBy:h.some(t.sortBy),sortOrder:h.some(t.sortOrder),query:t.query,fileTypes:uo(t.fileTypes)})).then(ut((e=>Kr(e).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>L.value(Vr(h.none(),e))))))))(e,t),listStarred:t=>((e,t,r)=>{return lo(e,"client/files/stars",(o={offset:t.offset,sortBy:h.some(t.sortBy),sortOrder:h.some(t.sortOrder),query:t.query,fileTypes:uo(t.fileTypes)},Fr(o,{offset:h.some,sortBy:x,sortOrder:x,query:x,fileTypes:h.some}))).then(ut((e=>{return(t=e,Pr("starsResult",oo,t)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>{return L.value((h.none(),Mr((t=e).files,t.last,t.offset)));var t}));var t})));var o})(e,t),search:t=>((e,t,r)=>lo(e,"client/files/search",Jr({offset:t.offset,parent:h.none(),sortBy:h.some(t.sortBy),sortOrder:h.some(t.sortOrder),query:t.query,fileTypes:uo(t.fileTypes)})).then(ut((e=>Kr(e).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>L.value(Vr(h.none(),e))))))))(e,t),remove:t=>((e,t)=>{return lo(e,"client/files/delete",(r={ids:t},Fr(r,{ids:h.some}))).then(ut((e=>{return(r=e,Pr("remove",Xr,r)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(()=>L.value(t)));var r})));var r})(e,t),copy:(t,r)=>((e,t,r)=>{return lo(e,"client/files/copy",(o={id:t,parent:r},Fr(o,{parent:x,id:h.some}))).then(ut((e=>{return(r=e,Pr("copy",Br,r)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(()=>L.value(t)));var r})));var o})(e,t,h.from(r)),move:(t,r)=>((e,t,r)=>{return lo(e,"client/files/move",(o={ids:t,parent:r},Fr(o,{parent:x,ids:h.some}))).then(ut((e=>{return(r=e,Pr("move",Zr,r)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(()=>L.value(t)));var r})));var o})(e,t,h.from(r)),star:t=>((e,t)=>lo(e,"client/files/star",to({ids:t})).then(ut((e=>{return(r=e,Pr("star",ro,r)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(()=>L.value(t)));var r}))))(e,t),unstar:t=>((e,t)=>lo(e,"client/files/unstar",no({ids:t})).then(ut((e=>{return(r=e,Pr("unstar",so,r)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(()=>L.value(t)));var r}))))(e,t),setMeta:(t,r)=>((e,t,r)=>{return lo(e,"client/files/setMeta",(o={id:t,description:r.description},Fr(o,{id:h.some,description:h.some}))).then(ut((e=>{return(r=e,Pr("setFileMeta",eo,r)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>L.value(t)));var r})));var o})(e,t,r),getMeta:t=>((e,t)=>{return lo(e,"client/files/getMeta",(r={id:t},Fr(r,{id:h.some}))).then(ut((e=>{return(t=e,Pr("getFileMeta",Wr,t)).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>L.value({description:e.description,createdBy:e.createdBy})));var t})));var r})(e,t),uploadToPath:t=>((e,t,r,o,n)=>((e,t,r,o,n)=>lo(e,"client/files/create",Rr({fileType:t,parent:h.none(),path:h.some(r),name:o,size:n})).then(ut((e=>Ar(e).fold((e=>L.error({type:"",message:"Could not decode http json response"})),(e=>L.value(e)))))))(e,Nr.File,n,r,t.size).then(lt((n=>mo(0,n,r,t,o).then(lt((t=>co(e,t,jr.File)))).then(ut((e=>L.value(Er(e.file)))))))))(e,t.blob,t.name,t.progress,t.path).then(lt(ho(e,t.thumbBlob,t.name)))}),go=e=>{const t=e.jwtTokenFactory;return e.demoFilesUrl.fold((()=>e.demoFiles.fold((()=>((e,t,r)=>{const o=t.getOrDie("Failed to get service url"),n=r.getOrDie("Failed to get api key");return fo({jwtTokenFactory:e,restApiEndpoint:o,apiKey:n})})(t,e.serviceUrl,e.apiKey)),(e=>((e,t)=>Or({jwtTokenFactory:e,requestDelay:0,log:!1,limit:30},Promise.resolve(L.value(t))))(t,e)))),(e=>((e,t)=>((e,t)=>{const r=(o={url:t,responseType:Pe.JSON},Ce({...o,method:"get",body:{type:Pe.Text,data:""}})).toPromise().then((e=>e.fold((e=>L.error({type:"",message:"fs error"})),(e=>{return L.value((r=pt(t).replace(/\/[^\/]*\/?$/,""),o=e.files,M(o,(e=>({...e,url:Ur(r,e.url),thumbUrl:Ur(r,e.thumbUrl)})))));var r,o}))));var o;return Or(e,r)})({jwtTokenFactory:e,requestDelay:0,log:!1,limit:30},t))(t,e)))},yo=e=>"media"===e?["directory","video","audio"]:"image"===e?["directory","image"]:[],vo=(e,t)=>{const r=Ye(t),o=Ze(t),n=Xe(t),s=Ge(t);return{close:!0,insert:!0,fullscreen:!1,target:h.none(),fileTypes:[],zIndex:65536,maxImageDimension:r,dropboxAppKey:o,googleDriveDeveloperKey:n,googleDriveClientId:s,baseUrl:e}},bo=(e,t)=>{return r={js:He(e),css:rt(e,t)},Promise.all([fe(G($,"tinymce").or(G($,"tinydrive")).getOrThunk((()=>{const e={};return $.tinydrive=e,e})),"_assetManagerProvider",r.js),he(r.css)]).then((([e,t])=>t.bind(T(e))));var r},wo=(e,t,r,o)=>new Promise((n=>{bo(e,t).then((s=>{s.fold((e=>{console.error(e)}),(s=>{let a=b;a=s(r,((e,t)=>h.from(t.filetype).map(yo).fold(T(e),(t=>({...e,fileTypes:t}))))(vo(t,e),o),(e=>{a(),n(e)}))}))}))})),To=(e,t,r)=>{wo(e,t,r,{filetype:""}).then((t=>{C(t,(t=>((e,t)=>{t.url.each((r=>{var o;e.insertContent((o=t.name,((e,t,r=O)=>e.exists((e=>r(e,t))))(Dt(o),"image")?((e,t)=>e.dom.createHTML("img",{src:t}))(e,r):((e,t,r)=>e.dom.createHTML("a",{href:t},e.dom.encode(r.name)))(e,r,t)))}))})(e,t)))}))},xo=e=>t=>{const r=()=>{const r=e.selection.isEditable();t.setEnabled(!e.readonly&&r)};return e.on("NodeChange",r),()=>e.off("NodeChange",r)},Oo=(e,t)=>jo(document.createElement("canvas"),e,t),Uo=e=>{const t=Oo(e.width,e.height);return ko(t).drawImage(e,0,0),t},ko=e=>e.getContext("2d"),jo=(e,t,r)=>(e.width=t,e.height=r,e),_o=e=>e.naturalWidth||e.width,Po=e=>e.naturalHeight||e.height,Do=e=>{const t=URL.createObjectURL(e),r=new Image;return r.src=t,(o=re(r),new Promise(((e,t)=>{const r=()=>{s(),e(o)},n=[ce(o,"load",r),ce(o,"error",(()=>{s(),t("Unable to load data from image: "+o.dom.src)}))],s=()=>C(n,(e=>e.unbind()));o.dom.complete&&r()}))).then((e=>e.dom));var o},So=(e,t,r)=>{return t=t||"image/png",p(HTMLCanvasElement.prototype.toBlob)?new Promise(((o,n)=>{e.toBlob((e=>{e?o(e):n()}),t,r)})):(o=e.toDataURL(t,r),new Promise(((e,t)=>{(e=>{const t=e.split(","),r=/data:([^;]+)/.exec(t[0]);if(!r)return h.none();const o=r[1],n=t[1],s=1024,a=atob(n),i=a.length,l=Math.ceil(i/s),u=new Array(l);for(let e=0;e<l;++e){const t=e*s,r=Math.min(t+s,i),o=new Array(r-t);for(let e=t,n=0;e<r;++n,++e)o[n]=a[e].charCodeAt(0);u[e]=new Uint8Array(o)}return h.some(new Blob(u,{type:o}))})(o).fold((()=>{t("uri is not base64: "+o)}),e)})));var o},Eo=(e,t,r)=>{const o=t.type,n=T(o),s=T(r),a=(t,r)=>e.then((e=>((e,t,r)=>(t=t||"image/png",e.toDataURL(t,r)))(e,t,r)));return{getType:n,toBlob:()=>Promise.resolve(t),toDataURL:s,toBase64:()=>r.split(",")[1],toAdjustedBlob:(t,r)=>e.then((e=>So(e,t,r))),toAdjustedDataURL:a,toAdjustedBase64:(e,t)=>a(e,t).then((e=>e.split(",")[1])),toCanvas:()=>e.then(Uo)}},Mo=e=>(e=>new Promise((t=>{const r=new FileReader;r.onloadend=()=>{t(r.result)},r.readAsDataURL(e)})))(e).then((t=>Eo((e=>Do(e).then((e=>{(e=>{URL.revokeObjectURL(e.src)})(e);const t=Oo(_o(e),Po(e));return ko(t).drawImage(e,0,0),t})))(e),e,t))),Co=e=>Mo(e);(e=>{if(!l(e))throw new Error("cases must be an array");if(0===e.length)throw new Error("there must be at least one case");const t=[],r={};C(e,((o,n)=>{const s=J(o);if(1!==s.length)throw new Error("one and only one name per case");const a=s[0],i=o[a];if(void 0!==r[a])throw new Error("duplicate key detected:"+a);if("cata"===a)throw new Error("cannot have a case named cata (sorry)");if(!l(i))throw new Error("case arguments must be an array");t.push(a),r[a]=(...r)=>{const o=r.length;if(o!==i.length)throw new Error("Wrong number of arguments to case "+a+". Expected "+i.length+" ("+i+"), got "+o);return{fold:(...t)=>{if(t.length!==e.length)throw new Error("Wrong number of arguments to fold. Expected "+e.length+", got "+t.length);return t[n].apply(null,r)},match:e=>{const o=J(e);if(t.length!==o.length)throw new Error("Wrong number of arguments to match. Expected: "+t.join(",")+"\nActual: "+o.join(","));if(!((e,t)=>{for(let t=0,n=e.length;t<n;++t)if(!0!==(r=e[t],S(o,r)))return!1;var r;return!0})(t))throw new Error("Not all branches were specified when using match. Specified: "+o.join(", ")+"\nRequired: "+t.join(", "));return e[a].apply(null,r)},log:e=>{console.log(e,{constructors:t,constructor:a,params:r})}}}}))})([{bothErrors:["error1","error2"]},{firstError:["error1","value2"]},{secondError:["value1","error2"]},{bothValues:["value1","value2"]}]);const Fo=(e,t,r)=>{const o=_o(e),n=Po(e);let s=t/o,a=r/n,i=!1;(s<.5||s>2)&&(s=s<.5?.5:2,i=!0),(a<.5||a>2)&&(a=a<.5?.5:2,i=!0);const l=Bo(e,s,a);return i?l.then((e=>Fo(e,t,r))):l},Bo=(e,t,r)=>new Promise((o=>{const n=_o(e),s=Po(e),a=Math.floor(n*t),i=Math.floor(s*r),l=Oo(a,i);ko(l).drawImage(e,0,0,n,s,0,0,a,i),o(l)})),No=(e,t)=>Co(e).then((e=>((e,t,r)=>((e,t,r)=>e.toCanvas().then((o=>Fo(o,t,r).then((t=>((e,t)=>So(e,t).then((t=>Eo(Promise.resolve(e),t,e.toDataURL()))))(t,e.getType()))))))(e,t,r))(e,t.width,t.height))).then((t=>t.toAdjustedBlob(e.type,9))),Ro=["image/jpeg","image/png","image/gif","image/webp","image/apng"],zo=(e,t)=>Math.max(e.width/t.width,e.height/t.height),Ao=(e,t)=>(e=>(e=>Do(e))(e).then((e=>{const t=e.naturalWidth,r=e.naturalHeight;return URL.revokeObjectURL(e.src),{width:t,height:r}})))(e).then((r=>zo(r,t)>1?No(e,((e,t)=>{const r=zo(e,t);return{width:Math.round(e.width/r),height:Math.round(e.height/r)}})(r,t)):Promise.resolve(e))),Io=e=>Co(e).then((e=>e.toBlob())),qo=(e,t)=>(e=>S(Ro,e.type))(e)?((e,t)=>((e,t)=>t.map((t=>Ao(e,{width:t,height:t}))).getOrThunk((()=>Promise.resolve(e))).then(Io).then((e=>Ao(e,{width:512,height:512}).then((t=>L.value({blob:e,thumbBlob:h.some(t)}))))))(e,t).then(dt(yt)))(e,t):Promise.resolve(L.value({blob:e,thumbBlob:h.none()})),Lo=e=>qo(e.blob,e.maxImageDimension).then(lt((t=>e.fs.uploadToPath({blob:t.blob,thumbBlob:t.thumbBlob,name:e.name,progress:e.progress,path:e.path})))),$o=Kt([(Wo=Qt,ur("filetypes",[],Vt(Wo)))]),Jo=Kt([ur("path","/",Qt),sr("name"),(e=>rr(e,e,{tag:"required",process:{}},Zt()))("blob"),((e,t)=>ur("onprogress",t,tr))(0,b),rr("max_image_dimension","maxImageDimension",{tag:"option",process:{}},Gt)]),Ho=(e,t)=>{let r=String(e);if(r.length<t)for(let e=0;e<t-r.length;e++)r="0"+r;return r},Ko=e=>e.url.map((t=>{return{name:e.name,url:t,size:e.size,type:St(e.type),mdate:(r=e.modificationDate,((e,t)=>{const r="Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),o="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),n="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),s="January February March April May June July August September October November December".split(" ");return(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace("%D","%m/%d/%Y")).replace("%r","%I:%M:%S %p")).replace("%Y",""+t.getFullYear())).replace("%m",Ho(t.getMonth()+1,2))).replace("%d",Ho(t.getDate(),2))).replace("%H",""+Ho(t.getHours(),2))).replace("%M",""+Ho(t.getMinutes(),2))).replace("%S",""+Ho(t.getSeconds(),2))).replace("%I",""+((t.getHours()+11)%12+1))).replace("%p",t.getHours()<12?"AM":"PM")).replace("%B",""+s[t.getMonth()])).replace("%b",""+n[t.getMonth()])).replace("%A",""+o[t.getDay()])).replace("%a",""+r[t.getDay()])).replace("%%","%")})("%Y-%m-%dT%H:%M:%SZ",(e=>new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()))(r)))};var r})),Vo=(e,t,r,o,n)=>Promise.resolve((e=>Wt("picker settings",$o,e).mapError(Yt))(o)).then(lt((o=>((e,t,r,o)=>new Promise((n=>{bo(e,t).then((e=>{e.fold((e=>n(L.error(e))),(e=>{let t=b;t=e(r,o,(e=>{t(),n(L.value(e))}))}))}))})))(e,t,r,{...vo(t,e),fileTypes:Mt(o.filetypes),insert:n})))).then(ut((e=>L.value({files:ht(M(e,Ko))}))));var Wo;tinymce.PluginManager.add("tinydrive",((t,r)=>{if(((e,t)=>!!e&&-1===((e,t)=>{const r=g(e.major,t.major);if(0!==r)return r;const o=g(e.minor,t.minor);if(0!==o)return o;const n=g(e.patch,t.patch);return 0!==n?n:0})((e=>v((e=>[e.majorVersion,e.minorVersion].join(".").split(".").slice(0,3).join("."))(e)))(e),v(t)))(tinymce,"6.4.0"))return console.error("The tinydrive plugin requires at least version 6.0.0 of TinyMCE."),{};((e,t)=>{const r=e.options.register;var o;r("tinydrive_api_key",{processor:"string"}),r("tinydrive_script_url",{processor:"string",default:t+"/assetmanager.min.js"}),r("tinydrive_demo_files_url",{processor:"string"}),r("tinydrive_demo_files",{processor:"object[]"}),r("tinydrive_service_url",{processor:"string"}),r("tinydrive_max_image_dimension",{processor:"number"}),r("tinydrive_dropbox_app_key",{processor:"string"}),r("tinydrive_google_drive_key",{processor:"string"}),r("tinydrive_google_drive_client_id",{processor:"string"}),r("tinydrive_css_url",{processor:"string"}),r("tinydrive_skin",{processor:e=>s(e)&&qe(e)}),r("tinydrive_token_provider",{processor:e=>s(e)||p(e)}),r("tinydrive_upload_path",{processor:"string",default:(o="/uploads",((e,t)=>{return r=`${e.getFullYear()}${ge(e.getMonth()+1)}${ge(e.getDate())}`,t.replace(/\/$/,"")+"/"+r.replace(/^\//,"");var r})(new Date,o))})})(t,r);const o=((e,t)=>go({demoFilesUrl:Ke(e),demoFiles:Ve(e),jwtTokenFactory:ot(e,t),serviceUrl:We(e),apiKey:Je(e)}))(t,e(h.none())),n=(e=>{const t={};return e.on("PreInit",(()=>{e.editorUpload.addFilter&&e.editorUpload.addFilter((e=>!1===t.hasOwnProperty(e.src)))})),e=>{t[e]=!0}})(t);return((e,t,r)=>{const o=e.options;if(!o.isSet("images_upload_handler")){const n=nt(e);o.set("images_upload_handler",((e,t,r,o)=>(n,s)=>{const a=p(s)?e=>s(Math.round(e.total/e.loaded*100)):b;return Lo({fs:e,path:t,name:n.filename(),blob:n.blob(),progress:a,maxImageDimension:o}).then((e=>e.fold((e=>Promise.reject(e.message)),(e=>e.url.fold((()=>Promise.reject("Failed to get upload url")),(e=>(r(e),Promise.resolve(e))))))))})(t,n,r,Ye(e)))}})(t,o,n),((e,t,r)=>{e.ui.registry.addButton("insertfile",{icon:"browse",tooltip:"Insert file",onAction:()=>To(e,t,r),onSetup:xo(e)})})(t,r,o),((e,t,r)=>{e.ui.registry.addMenuItem("insertfile",{icon:"browse",text:"File",onAction:()=>To(e,t,r),onSetup:xo(e)})})(t,r,o),((e,t,r)=>{const o=e.options;o.isSet("file_picker_callback")||o.set("file_picker_callback",((o,n,s)=>{wo(e,t,r,s).then((e=>{A(e).each((e=>{e.url.each((t=>o(t,{title:e.name,text:e.name})))}))}))}))})(t,r,o),((e,t,r)=>({pick:o=>ct(Vo(e,t,r,o,!0)),browse:o=>ct(Vo(e,t,r,o,!1)).then(b),upload:t=>ct(((e,t,r)=>Promise.resolve((e=>Wt("upload settings",Jo,e).mapError(Yt))(r)).then(lt((r=>{return Lo({fs:t,path:r.path,name:r.name,blob:r.blob,progress:(o=r.onprogress,({loaded:e,total:t})=>{o({loaded:e,total:t})}),maxImageDimension:r.maxImageDimension.or(Ye(e))}).then(ut((e=>L.fromOption(Ko(e).map((e=>({file:e}))),yt("Failed to get upload file"))))).then(dt((e=>e.message)));var o}))))(e,r,t))}))(t,r,o)}))}();